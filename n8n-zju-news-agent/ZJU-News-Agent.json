{
  "name": "imformation",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        640,
        480
      ],
      "id": "3d009960-41f6-4f04-9726-d9fd1147024d",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "url": "https://www.zju.edu.cn/",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "pageSize",
              "value": "20"
            },
            {
              "name": "page",
              "value": "1"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1488,
        624
      ],
      "id": "68fb82ac-6a8f-412d-ac61-130848370e4d",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 8192
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        3088,
        720
      ],
      "id": "4e7ad0dc-a85a-457f-89fd-e69f25858769",
      "name": "DeepSeek Chat Model1",
      "credentials": {
        "deepSeekApi": {
          "id": "9jTgKXnJS0RvGznL",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Current Date: {{ new Date().toLocaleDateString('zh-CN') }}\n\nUser Preferences (Focus on these topics):\n{{ $('Build Preference String').first().json.preferenceString }}\n\nInput News Data:\n{{ $json.formattedNews }}\n\n=== TASK ===\nAnalyze the \"Input News Data\" and generate a structured JSON array. For each news item, return an object with these fields:\n\n1. \"title\": The original title (clean up any garbled text if necessary).\n2. \"link\": The original URL.\n3. \"source\": The source name (e.g., \"æ•™åŠ¡å†…ç½‘\", \"å°±ä¸šç½‘\").\n4. \"category\": Classify into one of: [å­¦æœ¯/ç§‘ç ”, å®ä¹ /å°±ä¸š, äº¤æ¢/ç•™å­¦, æ•™åŠ¡é€šçŸ¥, è®²åº§/æ´»åŠ¨, å…¶ä»–].\n5. \"priority\": Integer (1, 2, or 3).\n   - 1 (High): Strongly matches User Preferences OR is urgent/has an upcoming deadline within 7 days.\n   - 2 (Medium): Partially matches preferences or general important university news.\n   - 3 (Low): Loose match or routine announcements.\n6. \"summary\": A 1-sentence summary. If the news mentions a specific deadline, time, or location, MUST include it. (e.g., \"æˆªæ­¢æ—¥æœŸä¸º1æœˆ20æ—¥\", \"åœ°ç‚¹åœ¨ç´«é‡‘æ¸¯\").\n7. \"reasoning\": Why did you give this priority? (e.g., \"åŒ¹é…ç”¨æˆ·åå¥½'è®¡ç®—æœº'\", \"è¿‘æœŸæˆªæ­¢çš„äº¤æ¢é¡¹ç›®\").\n\n=== OUTPUT FORMAT ===\nReturn ONLY the raw JSON array.\nExample:\n[\n  {\n    \"title\": \"...\",\n    \"link\": \"...\",\n    \"source\": \"...\",\n    \"category\": \"...\",\n    \"priority\": 1,\n    \"summary\": \"...\",\n    \"reasoning\": \"...\"\n  }\n]",
        "options": {
          "systemMessage": "=You are a highly intelligent news analysis API for Zhejiang University students. \nYour ONLY function is to process raw news data into a strictly structured JSON array.\n\nCRITICAL RULES:\n1. Output MUST be a valid JSON array.\n2. Do NOT use Markdown code blocks (no ```json or ```). Just return the raw array.\n3. Do NOT output any conversational text, explanations, or warnings.\n4. If the input news list is empty, return \"[]\".\n5. Use Chinese (Simplified) for all generated fields (summary, reasoning, category)."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3008,
        496
      ],
      "id": "c8f4ba6a-33c5-488e-a316-8ab60a41be36",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "jsCode": "const html = $json.body || $json.data;\n\n// 1. æŠ“å– JS æ•°ç»„ main._newsJsonXXX = [...]\nconst regex = /main\\._newsJson\\d+\\s*=\\s*(\\[[\\s\\S]*?\\])/;\nconst match = html.match(regex);\n\nif (!match) {\n\treturn [{\n\t\tjson: {\n\t\t\tsuccess: false,\n\t\t\tmessage: \"æœªæ‰¾åˆ° main._newsJsonXXX\"\n\t\t}\n\t}];\n}\n\nlet jsArray = match[1];\n\nlet fixed = jsArray\n\n\t// å»é™¤æ³¨é‡Šç­‰ç‰¹æ®Šç¬¦å·\n\t.replace(/\\/\\*[\\s\\S]*?\\*\\//g, '')\n\n\t// key: â†’ \"key\":\n\t.replace(/(\\w+)\\s*:/g, '\"$1\":')\n\n\t// å»æ‰ JSON.stringify(`...`)\n\t.replace(/JSON\\.stringify\\(`([\\s\\S]*?)`\\)/g, '\"$1\"')\n\n\t// å•å¼•å· â†’ åŒå¼•å·\n\t.replace(/'([^']*)'/g, '\"$1\"')\n\n\t// åˆ é™¤ obj å°¾é€—å·ï¼š { ... , }\n\t.replace(/,\\s*}/g, '}')\n\n\t// åˆ é™¤ array å°¾é€—å·ï¼ˆåŒ…æ‹¬å„ç§æ ¼å¼ï¼‰\n\t.replace(/,\\s*\\]/g, ']')\n\t.replace(/,\\s*\\r?\\n\\s*\\]/g, ']')\n\t.replace(/,\\s*\\r?\\n*\\s*\\]/g, ']')\n\n\t// åˆ é™¤ç©ºå¯¹è±¡ï¼š{}, æˆ–è€… , {}\n\t.replace(/,\\s*\\{\\s*\\}/g, '')\n\t.replace(/\\{\\s*\\}/g, '');\n\n\n// 3. å°è¯•è§£æ\nlet arr;\ntry {\n\tarr = JSON.parse(fixed);\n} catch (e) {\n\treturn [{\n\t\tjson: {\n\t\t\tsuccess: false,\n\t\t\tmessage: \"JSON è§£æä»å¤±è´¥ï¼ˆæ‰“å° fixed ä»¥ç»§ç»­è°ƒè¯•ï¼‰\",\n\t\t\terror: e.toString(),\n\t\t\trawFixed: fixed\n\t\t}\n\t}];\n}\n\n// 4. æ¸…ç†å¹¶è¾“å‡º\nreturn arr\n\t.filter(item => item && item.title)\n\t.map(item => ({\n\t\tjson: {\n\t\t\ttitle: item.title,\n\t\t\tlink: item.href,\n\t\t\timage: item.image,\n\t\t\ttext: item.text,\n\t\t\tpubDate: item.time,\n\t\t\traw: item\n\t\t}\n\t}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1728,
        640
      ],
      "id": "0c9865c0-4bb0-4aca-adc7-847972496ba9",
      "name": "æ±‚æ˜¯æ–°é—» Code"
    },
    {
      "parameters": {
        "jsCode": "// 1. è·å– API è¿”å›çš„è®°å½•\n// æ³¨æ„ï¼šå¦‚æœä¸ç¡®å®šä¸Šä¸€ä¸ªèŠ‚ç‚¹åï¼Œå¯ä»¥ç”¨ $input.all()[0].json.result.records\nconst records = $items(\"Career Lecture Request\")[0].json.result.records || [];\nconst today = new Date();\ntoday.setHours(0,0,0,0);\n\n// 2. ä½ çš„å…³é”®è¯è®¾ç½®\nconst keywords = [\"è®¡ç®—æœº\", \"é¦™æ¸¯\", \"äº’è”ç½‘\", \"å®ä¹ \", \"è½¯ä»¶\", \"ä¿¡æ¯æŠ€æœ¯\"];\n\n// 3. è¿‡æ»¤ + ç”Ÿæˆæ™ºèƒ½é“¾æ¥\nconst lectureNews = records\n  .filter(item => {\n    const date = new Date(item.xjhrq);\n    // ç­›é€‰æ¡ä»¶ï¼šæ—¥æœŸåœ¨ä»Šå¤©ä¹‹å ä¸” æ ‡é¢˜åŒ…å«å…³é”®è¯\n    return !isNaN(date.getTime()) && date >= today && keywords.some(k => item.xjhmc.includes(k));\n  })\n  .map(item => {\n    // === ğŸ”¥ æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ ===\n    let url = \"\";\n    \n    // æƒ…å†µ A: æ•°æ®å®Œæ•´ï¼Œç›´æ¥è·³è½¬åˆ°ã€å²—ä½è¯¦æƒ…é¡µã€‘(ckXjhgwXq)\n    if (item.dwxxid && item.dwxxid !== \"null\") {\n        url = `https://www.career.zju.edu.cn/jyxt/sczp/xjhgl/ckXjhgwXq.zf?xjhbh=${item.xjhbh}&dwxxid=${item.dwxxid}`;\n    } \n    // æƒ…å†µ B: ç¼ºå°‘å•ä½IDï¼Œå›é€€åˆ°ã€å®£è®²ä¼šå²—ä½åˆ—è¡¨é¡µã€‘(ckXjhgw) - å»æ‰ Xq å’Œ dwxxid\n    else {\n        url = `https://www.career.zju.edu.cn/jyxt/sczp/xjhgl/ckXjhgw.zf?xjhbh=${item.xjhbh}`;\n    }\n    // === ğŸ”¥ æ ¸å¿ƒä¿®å¤é€»è¾‘ç»“æŸ ===\n\n    return {\n      title: item.xjhmc,\n      link: url,\n      pubDate: item.xjhrq,\n      source: \"å°±ä¸šä¿¡æ¯ç½‘\"\n    };\n  });\n\nreturn lectureNews.map(item => ({ json: item }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1712,
        192
      ],
      "id": "41bcdb09-13cb-4d29-adab-4f538838e35e",
      "name": "ZJU Career Filter"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://www.career.zju.edu.cn/v5-api/jyxt/wzsy/getZhXjhQtListAjax.zf",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1488,
        192
      ],
      "id": "16ee50f8-a979-4a21-8ae0-de2d60e8a31d",
      "name": "Career Lecture Request"
    },
    {
      "parameters": {
        "jsCode": "// 1. è·å–æ‰€æœ‰è¾“å…¥æ¡ç›® (ä½¿ç”¨ $input.all() æ›¿ä»£ $items()ï¼Œæ›´ç¨³å®š)\nconst items = $input.all().map(item => item.json);\n\n// å¦‚æœæ²¡æœ‰æ–°é—»ï¼Œç›´æ¥è¿”å›ç©ºï¼Œé¿å…å‘ç©ºé‚®ä»¶\nif (items.length === 0) {\n  return [{ json: { html: \"<h3>ä»Šæ—¥æ— ç›¸å…³æ–°é—»</h3>\", totalNews: 0 } }];\n}\n\n// 2. ä¿®å¤ URLï¼šæ ¹æ®æ¥æºæˆ–è·¯å¾„è‡ªåŠ¨è¡¥å…¨åŸŸå\nfunction fixUrl(link, source) {\n  if (!link) return link;\n  \n  // å»é™¤ç©ºæ ¼\n  link = link.trim();\n\n  // å·²ç»æ˜¯å®Œæ•´ URL\n  if (link.startsWith(\"http://\") || link.startsWith(\"https://\")) {\n    return link;\n  }\n\n  // äº¤æ¢é¡¹ç›®ï¼ˆæœ¬ç§‘ç”Ÿé™¢ ugrsï¼‰\n  if (source && source.includes(\"äº¤æ¢\")) {\n    return \"https://ugrs.zju.edu.cn\" + (link.startsWith(\"/\") ? \"\" : \"/\") + link;\n  }\n\n  // å°±ä¸šä¿¡æ¯ç½‘\n  if (source && source.includes(\"å°±ä¸š\")) {\n    return \"https://www.career.zju.edu.cn\" + (link.startsWith(\"/\") ? \"\" : \"/\") + link;\n  }\n\n  // æœ¬ç§‘ç”Ÿé™¢ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ /dwjlfwpt/xxxxï¼‰\n  if (link.startsWith(\"/dwjlfwpt\") || link.startsWith(\"/20\")) {\n    return \"https://ugrs.zju.edu.cn\" + (link.startsWith(\"/\") ? \"\" : \"/\") + link;\n  }\n\n  // é»˜è®¤è¡¥å¤§å­¦å®˜ç½‘åŸŸå\n  return \"https://www.zju.edu.cn\" + (link.startsWith(\"/\") ? \"\" : \"/\") + link;\n}\n\n// åº”ç”¨ URL ä¿®å¤\nitems.forEach(item => {\n  item.link = fixUrl(item.link, item.source);\n});\n\n// 3. æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰\n// ä½¿ç”¨ Number() è½¬æ¢ï¼Œé˜²æ­¢ AI å¶å°”è¾“å‡ºå­—ç¬¦ä¸² \"1\" å¯¼è‡´æ’åºå¤±æ•ˆ\nconst sorted = items.sort((a, b) => {\n  const p1 = Number(a.priority) || 999;\n  const p2 = Number(b.priority) || 999;\n  return p1 - p2;\n});\n\n// 4. æŒ‰ç±»åˆ«åˆ†ç»„\nconst grouped = {};\nsorted.forEach(item => {\n  const cat = item.category || 'å…¶ä»–';\n  if (!grouped[cat]) grouped[cat] = [];\n  grouped[cat].push(item);\n});\n\n// 5. ç”Ÿæˆ HTML æŠ¥å‘Š\n// ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶ä½¿ç”¨åŒ—äº¬æ—¶é—´ (Asia/Shanghai)\n// å¦åˆ™åœ¨äº‘ç«¯æœåŠ¡å™¨ä¸Šè¿è¡Œå¯èƒ½ä¼šæ˜¾ç¤ºæ˜¨å¤©çš„æ—¥æœŸ\nconst today = new Date().toLocaleDateString('zh-CN', { \n  timeZone: 'Asia/Shanghai',\n  year: 'numeric', \n  month: 'long', \n  day: 'numeric',\n  weekday: 'long'\n});\n\nlet html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: 'Microsoft YaHei', -apple-system, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }\n    .container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }\n    h1 { color: #003366; border-bottom: 3px solid #003366; padding-bottom: 15px; margin-top: 0; text-align: center; }\n    .date { color: #666; font-size: 14px; margin-bottom: 30px; text-align: center; background: #eef2f5; padding: 8px; border-radius: 4px; display: inline-block; width: 100%; box-sizing: border-box; }\n    \n    .category { margin-top: 35px; }\n    .category-title { background: #003366; color: #fff; padding: 8px 15px; font-weight: bold; border-radius: 4px 4px 0 0; display: inline-block; font-size: 15px; }\n    .category-content { border-top: 2px solid #003366; margin-top: -2px; padding-top: 15px; }\n    \n    .news-item { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 6px; background: #fff; transition: all 0.2s; }\n    .news-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); border-color: #ddd; }\n    \n    .priority-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 8px; vertical-align: text-bottom; }\n    .priority-1 { background: #e63946; color: white; } /* çº¢è‰²é«˜äº® */\n    .priority-2 { background: #fca311; color: white; } /* æ©™è‰²ä¸­ç­‰ */\n    .priority-3 { background: #e9ecef; color: #495057; } /* ç°è‰²æ™®é€š */\n    \n    .news-title { font-weight: bold; font-size: 17px; margin-bottom: 8px; line-height: 1.4; color: #2c3e50; }\n    .news-meta { font-size: 12px; color: #999; margin-bottom: 10px; display: flex; align-items: center; }\n    .source-tag { background: #f1f3f5; padding: 2px 6px; border-radius: 3px; margin-right: 10px; color: #495057; }\n    \n    .news-summary { margin: 12px 0; color: #555; font-size: 14px; background: #f8f9fa; padding: 10px; border-left: 3px solid #dee2e6; border-radius: 0 4px 4px 0; }\n    .news-link { display: inline-block; color: #0066cc; text-decoration: none; font-weight: 500; font-size: 14px; margin-top: 5px; }\n    .news-link:hover { text-decoration: underline; color: #004499; }\n    \n    .reasoning { font-size: 12px; color: #868e96; margin-top: 10px; padding-top: 8px; border-top: 1px dashed #eee; font-style: italic; }\n    .footer { margin-top: 50px; text-align: center; color: #adb5bd; font-size: 12px; border-top: 1px solid #eee; padding-top: 20px; }\n  </style>\n</head>\n<body>\n<div class=\"container\">\n  <h1>ğŸ“ æµ™æ±Ÿå¤§å­¦æ¯æ—¥æ–°é—»ç®€æŠ¥</h1>\n  <div class=\"date\">ğŸ“… ${today}</div>\n`;\n\n// éå†æ¯ä¸ªç±»åˆ«\nfor (const [category, newsItems] of Object.entries(grouped)) {\n  html += `\n  <div class=\"category\">\n    <div class=\"category-title\">${category}</div>\n    <div class=\"category-content\">\n  `;\n  \n  newsItems.forEach(item => {\n    // å…¼å®¹å­—ç¬¦ä¸² \"1\" å’Œæ•°å­— 1\n    const pVal = Number(item.priority) || 3;\n    const priorityClass = `priority-${pVal}`;\n    \n    let priorityLabel = 'æ™®é€š';\n    if (pVal === 1) priorityLabel = 'ğŸ”¥ é‡è¦';\n    if (pVal === 2) priorityLabel = 'â­ å…³æ³¨';\n\n    html += `\n    <div class=\"news-item\">\n      <div class=\"news-title\">\n        <span class=\"priority-badge ${priorityClass}\">${priorityLabel}</span>\n        ${item.title || 'æ— æ ‡é¢˜'}\n      </div>\n      \n      <div class=\"news-meta\">\n        <span class=\"source-tag\">${item.source || 'æ ¡å†…é€šçŸ¥'}</span>\n      </div>\n\n      <div class=\"news-summary\">${item.summary || 'æš‚æ— æ‘˜è¦'}</div>\n      \n      <div>\n        <a href=\"${item.link}\" class=\"news-link\" target=\"_blank\">ğŸ”— ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</a>\n      </div>\n      \n      ${item.reasoning ? `<div class=\"reasoning\">ğŸ’¡ AIåˆ†æï¼š${item.reasoning}</div>` : ''}\n    </div>\n    `;\n  });\n  \n  html += `</div></div>`;\n}\n\nhtml += `\n  <div class=\"footer\">\n    æœ¬æŠ¥å‘Šç”± n8n AI Agent è‡ªåŠ¨ç”Ÿæˆ â€¢ å…±ç­›é€‰å‡º ${items.length} æ¡ç›¸å…³èµ„è®¯\n  </div>\n</div>\n</body>\n</html>\n`;\n\n// 6. è¿”å›ç»“æœ\nreturn [{\n  json: {\n    html: html,\n    totalNews: items.length,\n    subject: `æµ™å¤§æ—¥æŠ¥ (${today}) - ${items.length}æ¡æ›´æ–°`, // æ–¹ä¾¿åé¢å‘é‚®ä»¶ç›´æ¥å¼•ç”¨ä¸»é¢˜\n    date: today\n  }\n}];"
      },
      "id": "87c8593d-f56d-40a3-abbe-324a9340feec",
      "name": "Format Daily Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3584,
        496
      ]
    },
    {
      "parameters": {
        "sendTo": "ä½ çš„é‚®ç®±åœ°å€@example.com",
        "subject": "=æµ™æ±Ÿå¤§å­¦æ¯æ—¥æ–°é—»ç®€æŠ¥ - {{ new Date().toLocaleDateString(\"zh-CN\") }}",
        "message": "={{ $json.html }}",
        "options": {}
      },
      "id": "57bd5380-e4d9-4a8b-8f6d-e4b77a401f3c",
      "name": "Send Daily Report Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        3808,
        496
      ],
      "webhookId": "289b5d83-6adc-4d16-b8b4-2044281b4f3a",
      "credentials": {
        "gmailOAuth2": {
          "id": "GYbuAocVSPV88f7e",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "è¯·å¡«å…¥ä½ çš„åå¥½æ•°æ®åº“ID",
          "mode": "id"
        },
        "returnAll": true,
        "options": {}
      },
      "id": "e7ecf6ac-6034-41fc-9c71-895ca9b7a096",
      "name": "Get User Preferences from Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1488,
        400
      ],
      "credentials": {
        "notionApi": {
          "id": "KtMV3zHmgeoRcCBI",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ä½ çš„ Notion V2 èŠ‚ç‚¹è¿”å›çš„æ•°æ®å·²ç»è¢« n8n æ‰å¹³åŒ–ï¼Œä¾‹å¦‚ï¼š\n// property_title, property_priority, property_enabled, property_category\n\nconst items = $items().map(i => i.json);\n\n// 1. è½¬ä¸ºç»Ÿä¸€æ ¼å¼\nconst parsed = items.map(i => {\n  return {\n    name: i.property_title || i.name || \"æœªå‘½ååå¥½\",\n    priority: i.property_priority ?? 999,\n    enabled: i.property_enabled ?? false,\n    category: i.property_category || \"\"\n  };\n});\n\n// 2. åªä¿ç•™ enabled çš„åå¥½\nconst enabledPrefs = parsed.filter(p => p.enabled);\n\n// 3. æŒ‰ priority ä»å°åˆ°å¤§æ’åº\nenabledPrefs.sort((a, b) => a.priority - b.priority);\n\n// 4. ç”Ÿæˆåå¥½å­—ç¬¦ä¸²ï¼ˆæä¾›ç»™ DeepSeek çš„ promptï¼‰\nlet preferenceString = \"\\næˆ‘çš„åå¥½åŒ…æ‹¬ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š\\n\";\n\nenabledPrefs.forEach(p => {\n  preferenceString += `${p.priority}) ${p.name}\\n`;\n});\n\n// 5. è¾“å‡º\nreturn [\n  {\n    json: {\n      preferenceString,\n      parsedPreferences: enabledPrefs\n    }\n  }\n];\n\n"
      },
      "id": "7c7f6b7e-a4c7-42a9-bf6c-742a17fb7391",
      "name": "Build Preference String",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1728,
        432
      ]
    },
    {
      "parameters": {
        "jsCode": "// ========================================================\n// ğŸš€ ä¸‡èƒ½é€šåƒç‰ˆï¼šç§»é™¤æ‰€æœ‰é—¨æ§›ï¼Œå¼ºè¡Œè¯»å–\n// ========================================================\n\nconst allItems = $input.all();\n\nlet finalNewsList = [];\nlet debugLog = []; // ç”¨äºè®°å½•æœªè¢«è¯†åˆ«çš„æ•°æ®ç»“æ„\n\n// å®šä¹‰åƒåœ¾è¯\nconst junkKeywords = /^(æ— æ ‡é¢˜|æœªçŸ¥æ ‡é¢˜|ç¬¬ä¸€é¡µ|ä¸Šä¸€é¡µ|ä¸‹ä¸€é¡µ|å°¾é¡µ|è·³è½¬|Go|More|æ›´å¤š|è¡Œæ”¿æ–‡ä»¶|æ—¥å†æ´»åŠ¨|æœ€æ–°é€šçŸ¥|é‡ç‚¹æç¤º|å…¬ç¤ºå…¬å‘Š|Home|é¦–é¡µ|å½“å‰ä½ç½®)$/i;\n\nfor (const item of allItems) {\n  const json = item.json;\n\n  // 1. è·³è¿‡åå¥½è®¾ç½®æ•°æ® (ä¸åšå¤„ç†)\n  if (json.preferenceString || json.parsedPreferences) {\n    continue;\n  }\n\n  // === ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæ— å·®åˆ«æå–é€»è¾‘ ===\n  // ä¸ç®¡æ•°æ®ç»“æ„æ˜¯ properties.Title è¿˜æ˜¯ç›´æ¥çš„ Titleï¼Œå…¨éƒ¨å°è¯•è·å–\n\n  // A. å°è¯•æå–æ ‡é¢˜\n  // æŒ‰ç…§å¯èƒ½æ€§ä»é«˜åˆ°ä½æ’åˆ—\n  let title = \n    // æƒ…å†µ1: Notion æ ‡å‡†ç»“æ„\n    json.properties?.Title?.title?.[0]?.plain_text || \n    json.properties?.Name?.title?.[0]?.plain_text || \n    json.properties?.[\"æ ‡é¢˜\"]?.title?.[0]?.plain_text ||\n    // æƒ…å†µ2: Notion ç®€åŒ–ç»“æ„ (Flattened) æˆ– å¤–éƒ¨æ–°é—»\n    json.Title || \n    json.title || \n    json.name || \n    json.Name || \n    \"\";\n\n  // B. å°è¯•æå–é“¾æ¥\n  let link = \n    json.properties?.URL?.url || \n    json.properties?.Link?.url || \n    json.URL || \n    json.url || \n    json.link || \n    \"\";\n\n  // C. å°è¯•æå–æ—¥æœŸ\n  let date = \n    json.properties?.PubDate?.rich_text?.[0]?.plain_text || \n    json.properties?.FetchTime?.created_time ||\n    json.PubDate || \n    json.pubDate || \n    json.date || \n    json.created_time || \n    \"\";\n\n  // === ğŸ•µï¸â€â™‚ï¸ è°ƒè¯•æ¢é’ˆ ===\n  // å¦‚æœæå–ä¸åˆ°æ ‡é¢˜ï¼Œè®°å½•ä¸€ä¸‹å®ƒçš„æ ·å­ï¼Œçœ‹çœ‹å®ƒåˆ°åº•æ˜¯å•¥\n  if (!title) {\n     // å¦‚æœä¸æ˜¯ç©ºå¯¹è±¡ï¼Œå°±è®°å½•ä¸‹æ¥ Keys\n     if (Object.keys(json).length > 0) {\n         debugLog.push(`æ— æ³•è¯†åˆ«: Keys=[${Object.keys(json).join(\",\")}]`);\n     }\n     continue;\n  }\n\n  // === ğŸ›¡ï¸ åƒåœ¾è¿‡æ»¤ ===\n  // å¦‚æœæ ‡é¢˜åœ¨é»‘åå•é‡Œï¼Œè·³è¿‡\n  if (junkKeywords.test(title.trim()) || title.trim().length < 2) {\n      continue;\n  }\n// 2. ğŸš« æ–°å¢å±è”½ï¼šåªè¦æ ‡é¢˜é‡Œæœ‰ \"å…¬ç¤ºåå•\"ï¼Œç›´æ¥æ‰”æ‰\n  // (è¿™ä¹Ÿæ¶µç›–äº† \"ã€äº¤æµé¡¹ç›®ã€‘ã€å…¬ç¤ºåå•ã€‘\")\n  if (title.includes(\"å…¬ç¤ºåå•\")) {\n      // debugLog.push(`å±è”½å…¬ç¤º: ${title}`); // å¯é€‰ï¼šå¦‚æœä½ æƒ³åœ¨debugé‡Œçœ‹åˆ°å®ƒè¢«åˆ äº†\n      continue;\n  }\n  // D. å­˜å…¥åˆ—è¡¨\n  finalNewsList.push({\n    title: title.trim(),\n    link: link,\n    pubDate: date,\n    source: json.source || \"æ•™åŠ¡å†…ç½‘/Notion\", // é»˜è®¤ä¸ºå†…ç½‘\n    score: 1 // é»˜è®¤ç»™åˆ†\n  });\n}\n\n// === å»é‡ (é“¾æ¥ç›¸åŒåˆ™åˆå¹¶) ===\nconst uniqueMap = new Map();\nfinalNewsList.forEach(item => {\n    let key = item.link ? item.link.trim() : item.title;\n    if (!uniqueMap.has(key)) uniqueMap.set(key, item);\n});\nconst uniqueList = Array.from(uniqueMap.values());\n\n// === æ’åº (æ–°æ—¥æœŸåœ¨å‰) ===\n// ç®€å•æŒ‰æ—¥æœŸå­—ç¬¦ä¸²é™åº\nuniqueList.sort((a, b) => (b.pubDate || \"\").localeCompare(a.pubDate || \"\"));\n\n// æˆªå–å‰ 50 æ¡\nconst outputList = uniqueList.slice(0, 50);\n\nreturn [\n  {\n    json: {\n      formattedNews: JSON.stringify(outputList), \n      count: outputList.length,\n      // å¦‚æœè¿˜æœ‰æ²¡è¯»å‡ºæ¥çš„ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå®ƒä»¬çš„ç»“æ„ç‰¹å¾\n      debugKeys: debugLog.slice(0, 5).join(\" | \"), \n      rawCount: allItems.length\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2784,
        496
      ],
      "id": "5b1e26cb-ff75-4764-ab1c-1ec093522e52",
      "name": "Combine News"
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2016,
        544
      ],
      "id": "f7ee5725-2715-4e95-b91d-15b87176298f",
      "name": "Merge"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "mode": "id",
          "value": "è¯·å¡«å…¥ä½ çš„æ–°é—»æ•°æ®åº“ID",
          "__regex": "^([0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12})"
        },
        "limit": 100,
        "simple": false,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "key": "FetchTime|created_time",
              "condition": "on_or_after",
              "createdTimeValue": "={{ new Date(new Date().getTime() - 7 * 24 * 60 * 60 * 1000).toISOString() }}"
            }
          ]
        },
        "options": {
          "sort": {
            "sortValue": [
              {
                "timestamp": true,
                "key": "created_time",
                "direction": "descending"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1520,
        992
      ],
      "id": "e0379050-e200-4cf4-9769-56fa98dd6c0a",
      "name": "Get Cached News",
      "retryOnFail": true,
      "credentials": {
        "notionApi": {
          "id": "KtMV3zHmgeoRcCBI",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. è·å–åŸå§‹å†…å®¹ (å…¼å®¹ä¸åŒçš„ Agent è¾“å‡ºå­—æ®µå)\nconst raw = $json.output || $json.text || $json.message || \"\";\n\nif (!raw) {\n  // å¦‚æœ AI æ²¡è¯´è¯ï¼Œè¿”å›ç©ºæ•°ç»„ï¼Œé˜²æ­¢æŠ¥é”™\n  return [];\n}\n\nlet jsonString = raw;\n\n// 2. ğŸ”¥ æ ¸å¿ƒä¼˜åŒ–ï¼šä½¿ç”¨æ­£åˆ™æå–ç¬¬ä¸€ä¸ª [ ... ] ç»“æ„ ğŸ”¥\n// ä¸ç®¡ AI åœ¨ JSON å‰é¢è¯´äº†å¤šå°‘åºŸè¯ï¼Œæˆ–è€…åœ¨åé¢åŠ äº†ä»€ä¹ˆå¤‡æ³¨ï¼Œ\n// æˆ‘ä»¬åªæŠ“å–æœ€å¤–å±‚çš„æ–¹æ‹¬å·åŠå…¶å†…å®¹ã€‚\nconst match = raw.match(/\\[[\\s\\S]*\\]/);\nif (match) {\n  jsonString = match[0];\n}\n\n// 3. æ¸…ç†æ®‹ç•™çš„ Markdown æ ‡è®° (åŒé‡ä¿é™©)\njsonString = jsonString.replace(/```json/g, \"\").replace(/```/g, \"\").trim();\n\n// 4. è§£æ JSON\nlet arr;\ntry {\n  arr = JSON.parse(jsonString);\n} catch (e) {\n  // å¦‚æœè§£æå¤±è´¥ï¼ŒæŠ›å‡ºå¸¦åŸå§‹å†…å®¹çš„é”™è¯¯ï¼Œæ–¹ä¾¿è°ƒè¯•\n  throw new Error(\"è§£æå¤±è´¥ï¼ŒAI è¾“å‡ºçš„å†…å®¹ä¸æ˜¯åˆæ³• JSONã€‚åŸå§‹å†…å®¹ï¼š\" + raw);\n}\n\n// 5. æ ¼å¼æ ¡éªŒï¼šç¡®ä¿æ‹¿åˆ°çš„ä¸€å®šæ˜¯æ•°ç»„\nif (!Array.isArray(arr)) {\n  // å¦‚æœ AI å¶å°”åªè¿”å›äº†ä¸€ä¸ªå¯¹è±¡ {} è€Œä¸æ˜¯æ•°ç»„ [{}]ï¼Œå¸®å®ƒåŒ…ä¸€å±‚\n  arr = [arr];\n}\n\n// 6. è¾“å‡º\nreturn arr.map(item => ({ json: item }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3360,
        496
      ],
      "id": "df66f286-0e82-465d-99de-79b7d4a9f549",
      "name": "clean AI"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "Career Lecture Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get User Preferences from Notion",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Cached News",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "æ±‚æ˜¯æ–°é—» Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "æ±‚æ˜¯æ–°é—» Code": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "clean AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Career Lecture Request": {
      "main": [
        [
          {
            "node": "ZJU Career Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ZJU Career Filter": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Daily Report": {
      "main": [
        [
          {
            "node": "Send Daily Report Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Preferences from Notion": {
      "main": [
        [
          {
            "node": "Build Preference String",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Preference String": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Combine News": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Combine News",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Cached News": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "clean AI": {
      "main": [
        [
          {
            "node": "Format Daily Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5d828745-6970-46ed-aea8-44edf4f48a1b",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": ""
  },
  "id": "TDJ4aVJt4yqZrnye",
  "tags": []
}